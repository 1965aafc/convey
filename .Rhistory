alpha2<- 1-alpha
quant_inf <-  svyquantile(x = formula, design = design, quantiles = alpha1, method = "constant")
quant_inf<-as.vector(quant_inf)
quant_sup <- svyquantile(x = formula, design = design, quantiles= alpha2, method = "constant")
quant_sup <- as.vector(quant_sup)
tot_var<- coef(svytotal(x=formula, design = design))
dsub80<- subset (design, subset= (incvar > quant_sup))
S80 <- coef(svytotal(x= formula ,dsub80))
dsub20<- subset (design, subset= (incvar<= quant_inf))
S20 <- coef(svytotal(~eqIncome,dsub20))
qsr<- S80/S20
# Linearization of S20
lin_S20 <- isq(formula = formula, design = design, alpha1, type="inf")
# Linearization of S80
lin_S80 <- isq(formula = formula, design = design, alpha2, type="sup")
# LINEARIZED VARIABLE OF THE SHARE RATIO
lin_share_ratio<-(S20*lin_S80-S80*lin_S20)/(S20*S20)
# estimate variance
design$variables$lin_share_ratio <- lin_share_ratio
lin_share_ratio_tot <- svytotal(~lin_share_ratio,design= design)
var_lin_share_ratio <- attr(lin_share_ratio_tot, "var")
list_share_ratio <- list(value = share_ratio, se = sqrt(var_lin_share_ratio ),
lin = lin_share_ratio )
list_share_ratio
}
# example
d4<-svyqsr(~eqIncome, des_eusilc, .20)
str(d4)
svyqsr <- function(formula, design, alpha= .20) {
inc <- terms.formula(formula)[[2]]
df <- model.frame(design)
incvar<-df[[as.character(inc)]]
alpha1<- alpha
alpha2<- 1-alpha
quant_inf <-  svyquantile(x = formula, design = design, quantiles = alpha1,
method = "constant")
quant_inf<-as.vector(quant_inf)
quant_sup <- svyquantile(x = formula, design = design, quantiles= alpha2,
method = "constant")
quant_sup <- as.vector(quant_sup)
tot_var<- coef(svytotal(x=formula, design = design))
dsub80<- subset (design, subset= (incvar > quant_sup))
S80 <- coef(svytotal(x= formula ,dsub80))
dsub20<- subset (design, subset= (incvar<= quant_inf))
S20 <- coef(svytotal(x= formula,dsub20))
qsr<- S80/S20
# Linearization of S20
lin_S20 <- isq(formula = formula, design = design, alpha1, type="inf")
# Linearization of S80
lin_S80 <- isq(formula = formula, design = design, alpha2, type="sup")
# LINEARIZED VARIABLE OF THE SHARE RATIO
lin_share_ratio<-(S20*lin_S80-S80*lin_S20)/(S20*S20)
# estimate variance
design$variables$lin_share_ratio <- lin_share_ratio
lin_share_ratio_tot <- svytotal(~lin_share_ratio,design= design)
var_lin_share_ratio <- attr(lin_share_ratio_tot, "var")
list_share_ratio <- list(value = share_ratio, se = sqrt(var_lin_share_ratio ),
lin = lin_share_ratio )
list_share_ratio
}
# example
d4<-svyqsr(~eqIncome, des_eusilc, .20)
str(d4)
isq <- function(formula, design, alpha,type=c("inf","sup")){
inc <- terms.formula(formula)[[2]]
df <- model.frame(design)
incvar<-df[[as.character(inc)]]
q_alpha<- svyquantile(x =formula, design =design, quantiles = alpha, method="constant")
q_alpha<- as.vector(q_alpha)
w <- weights(design)
N <- sum (w)
Fprime<- densfun(formula = formula , design = design, q_alpha, type="S")
iq<- iqalpha(formula = formula, design = design, alpha)
isqalpha <- incvar*((incvar<=q_alpha))+ Fprime*iq
if(type=="inf")ires<- isqalpha else ires<- incvar - isqalpha
res
}
d4<-svyqsr(~eqIncome, des_eusilc, .20)
isq <- function(formula, design, alpha,type=c("inf","sup")){
inc <- terms.formula(formula)[[2]]
df <- model.frame(design)
incvar<-df[[as.character(inc)]]
q_alpha<- svyquantile(x =formula, design =design, quantiles = alpha, method="constant")
q_alpha<- as.vector(q_alpha)
w <- weights(design)
N <- sum (w)
Fprime<- densfun(formula = formula , design = design, q_alpha, type="S")
iq<- iqalpha(formula = formula, design = design, alpha)
isqalpha <- incvar*((incvar<=q_alpha))+ Fprime*iq
if(type=="inf")ires<- isqalpha else ires<- incvar - isqalpha
ires
}
d4<-svyqsr(~eqIncome, des_eusilc, .20)
source('~/GitHub/convey/all_funs.R', echo=TRUE)
d1 <-  svyarpt(~eqIncome, des_eusilc, .5, .6)
str(d1)
d2 <-svyarpr(~eqIncome, des_eusilc, .5, .6)
str(d2)
d3<- svyrmpg(~eqIncome, des_eusilc, .5, .6)
str(d3)
d4<-svyqsr(~eqIncome, des_eusilc, .20)
str(d4)
d5 <- svygini(~eqIncome, des_eusilc)
str(d5)
dati <- data.frame(IDd = 1:nrow(eusilc), eusilc)
d1vardpoor <- linarpt(Y="eqIncome", id="IDd", weight = "rb050", Dom = NULL,
dataset = dati, percentage = 60, order_quant=50)
d1vardpoor$value
summary(d1vardpoor$lin)
d1$value
summary(d1$lin)
d2vardpoor <- linarpt(Y="eqIncome", id="IDd", weight = "rb050", Dom = NULL,
dataset = dati, percentage = 60, order_quant=50)
d2vardpoor$value
summary(d2vardpoor$lin$lin_arpt)
d2vardpoor <- linarpt(Y="eqIncome", id="IDd", weight = "rb050", Dom = NULL,
dataset = dati, percentage = 60, order_quant=50)
d2vardpoor$value
summary(d2vardpoor$lin$lin_arpt)
d2vardpoor <- linarpr(Y="eqIncome", id="IDd", weight = "rb050", Dom = NULL,
dataset = dati, percentage = 60, order_quant=50)
d2vardpoor$value
summary(d2vardpoor$lin$lin_arpt)
summary(d2vardpoor$lin)
d2 <-svyarpr(~eqIncome, des_eusilc, .5, .6)
d2$value
summary(d2$lin)
d3vardpoor <- linqsr(Y="eqIncome", id="IDd", weight="rb050",
Dom=NULL, dataset= dati, alpha=20)
d3vardpoor$value
summary(d3vardpoor$lin)
d3vardpoor<-linrmpg(Y="eqIncome", id="IDd", weight="rb050", Dom=NULL,
dataset=dati, percentage=60, order_quant=50)
d3vardpoor$value
summary(d3vardpoor$lin)
d3<- svyrmpg(~eqIncome, des_eusilc, .5, .6)
d3$value
summary(d3$lin)
d4vardpoor <- linqsr(Y="eqIncome", id="IDd", weight="rb050",
Dom=NULL, dataset= dati, alpha=20)
d4vardpoor$value
summary(d4vardpoor$lin)
d4<-svyqsr(~eqIncome, des_eusilc, .20)
d4$value
summary(d4$lin)
d5vardpoor<-lingini(Y="eqIncome", id="IDd", weight="rb050", dataset=dati)
d5vardpoor<-lingini(Y="eqIncome", id="IDd", weight="rb050", dataset=dati)
d5vardpoor$value
summary(d5vardpoor$lin)
d5 <- svygini(~eqIncome, des_eusilc)
d5$gini_coef
summary(d5$lin)
library(survey)
data(api)
dclus1<-svydesign(id=~dnum, weights=~pw, data=apiclus1, fpc=~fpc)
class(svyquantile(~api00, dclus1, c(.25,.5,.75),ci=TRUE))
a <- svytotal(~api00+enroll+api99, dclus1)
a
class(a)
str(a)
svycontrast(a, quote(api00/api99))
3989986/ 3759623
moments<-svymean(~I(api00^3)+I(api00^2)+I(api00), dclus1)
class(moments)
moments
str(moments)
svycontrast(moments,
quote((`I(api00^3)`-3*`I(api00^2)`*`I(api00)`+ 3*`I(api00)`*`I(api00)`^2-`I(api00)`^3)/
(`I(api00^2)`-`I(api00)`^2)^1.5))
dx2x <- deriv(~ x^2, "x") ; dx2x
gini.exp<-expression((2x-y)/(yz))
gini.exp<-expression((2x-y)/(y*z))
gini.exp<-expression((2*x-y)/(y*z))
D(gini.exp)
D(gini.exp,"x")
deriv(gini.exp,c("x","y","z"))
source('~/GitHub/convey/all_funs.R', echo=TRUE)
formula <- ~eqIncome
design<- des_eusilc
inc <- terms.formula(formula)[[2]]
w<- weights(design)
df <- model.frame(design)
incvar<-df[[as.character(inc)]]
incvar <-incvar[order(incvar)]
w<-w[order(incvar)]
# population size
N <-  sum(w)
# sample size
n<-length(inc)
# total income
T <- sum(incvar*w)
# cumulative weight
r <- cumsum(w)
Num <- sum((2*r-1)*incvar*w)
Den <- N*T
# Gini coeficient
Gini<-(Num/Den)-1
Num
N
T
1.62751e+11/N
1.62751e+11/T
summary(incvar)
summary(w)
Den
T
class(incvar)
incvar[1:100]
w[1:100]
order(incvar)[1:100]
source('~/GitHub/convey/all_funs.R', echo=TRUE)
source('~/GitHub/convey/all_funs.R', echo=TRUE)
source('~/GitHub/convey/all_funs.R', echo=TRUE)
source('~/GitHub/convey/all_funs.R', echo=TRUE)
linmedp <- (.5*linarpt-ifmedp-.5*arpr)/Fprimemedp
source('~/GitHub/convey/all_funs.R', echo=TRUE)
source('~/GitHub/convey/all_funs.R', echo=TRUE)
source('~/GitHub/convey/all_funs.R', echo=TRUE)
library(survey)
data(api)
dclus1<-svydesign(id=~dnum, weights=~pw, data=apiclus1, fpc=~fpc)
svyratio(~api.stu, ~enroll, dclus1)
ratio_api_enroll<-svyratio(~api.stu, ~enroll, dclus1)
Xhat<-svytotal(~enroll,dclus1)
linratio <- (apiclus$api.stu-coef(ratio_api_enroll)*apiclus$enroll)/coef(Xhat)
linratio <- (apiclus$api.stu-coef(ratio_api_enroll)*apiclus1$enroll)/coef(Xhat)
linratio <- (apiclus1$api.stu-coef(ratio_api_enroll)*apiclus1$enroll)/coef(Xhat)
svytotal(linratio,dclus1)
deriv(x+y,"x")
deriv(expression(x+y),"x")
lixo<-deriv(expression(x+y),"x")
str(lixo)
deriv
?expression
expression(1 + 0:9))
expression(1 + 0:9)
I
Inf <- function(expression(I(a*T+b*S))) expression(a*IT+b*IS)
?deriv
dx2x <- deriv(~ x^2, "x") ; dx2x
dx2x <- deriv3(~ x^2, "x") ; dx2x
trig.exp <- expression(sin(cos(x + y^2)))
trig.exp
expression(I(a*T+b*S))
expression(a*IT+b*IS)
comb_lin<-function(expression(expression(I(a*T+b*S))))expression(a*IT+b*IS)
comb_lin<-function(expression(I(a*T+b*S)))expression(a*IT+b*IS)
comb_lin<-function(expression(I(a*T+b*S))) expression(a*IT+b*IS)
expression(I(a*T+b*S))
library(vardpoor)
data(eusilc)
dati <- data.table(IDd = 1:nrow(eusilc), eusilc)
d2 <- linarpt(Y="eqIncome", id="IDd", weight = "rb050", Dom = "db040",
dataset = dati, percentage = 60, order_quant=50)
d2$value
library(survey)
svyby
?svyby
setwd("~/GitHub/convey")
source('~/GitHub/convey/deriv_rules.R', echo=TRUE)
source('~/GitHub/convey/all_funs.R', echo=TRUE)
summary(eusilc$eqIncome)
des_eusilc <- update(des_eusilc, num = (eqIncome<= 20000)*1)
des_eusilc <- update(des_eusilc, den= rep(1,nrow(model.frame(des_eusilc))))
NUM<-itot(~num,des_eusilc)
itot<- function(formula,design){
inc <- terms.formula(formula)[[2]]
df <- model.frame(design)
incvar<-df[[as.character(inc)]]
value<-coef(svytotal(formula=formula,design=design))
lin<- incvar
list(value=value, lin=lin)
}
itot<- function(formula,design){
inc <- terms.formula(formula)[[2]]
df <- model.frame(design)
incvar<-df[[as.character(inc)]]
value<-coef(svytotal(x=formula,design=design))
lin<- incvar
list(value=value, lin=lin)
}
NUM<-itot(~num, des_eusilc)
DEN<-itot(~den, des_eusilc)
resul<- ratio_inf(NUM,DEN)
str(resul)
resul_icdf-icdf(~eqIncome,des_eusilc, 20000)
resul_icdf<-icdf(~eqIncome,des_eusilc, 20000)
str(resul_icdf)
?solve
solve(diag(1:5),(1:5)*2)
solve(10,5)
?`diag
?diag
diag(1,3,3)
diag(5,3,3)
icdf1<-function(formula, design, x,...){
inc <- terms.formula(formula)[[2]]
df <- model.frame(design)
incvar<-df[[as.character(inc)]]
w <- weights(design)
N <- sum (w)
poor<- (incvar<=x)*1
one <- rep(1, length(incvar))
design <- update(design, poor = poor, one=one)
NUM <- itot(~num, des_eusilc)
DEN <- itot(~den, des_eusilc)
cdf_fun <- NUM$value/DEN$value
inf_fun<-ratio_inf(NUM,DEN)
inf_fun
}
icdf1(~eqIncome,des_eusilc, 20000)->lixo
str(lixo)
ratio_inf<-function(T, S){
value <- T$value/S$value
(S$value*T$lin-T$value*S$lin)/((S$value)^2)
list(value=value, lin=lin)
}
icdf1(~eqIncome,des_eusilc, 20000)->lixo
icdf1<-function(formula, design, x,...){
inc <- terms.formula(formula)[[2]]
df <- model.frame(design)
incvar<-df[[as.character(inc)]]
poor<- (incvar<=x)*1
one <- rep(1, length(incvar))
design <- update(design, poor = poor, one=one)
NUM <- itot(~num, des_eusilc)
DEN <- itot(~den, des_eusilc)
cdf_fun <- NUM$value/DEN$value
inf_fun<-ratio_inf(NUM,DEN)$lin
list(value=cdf_fun, lin=inf_fun)
}
icdf1(~eqIncome,des_eusilc, 20000)->lixo
ratio_inf<-function(T, S){
value <- T$value/S$value
lin <- (S$value*T$lin-T$value*S$lin)/((S$value)^2)
list(value=value, lin=lin)
}
icdf1(~eqIncome,des_eusilc, 20000)->lixo
str(lixo)
MED<-svyquantile(~eqIncome,des_eusilc,quantiles=.5)
MED
MED<-as.vector(MED)
MED
SMED<- list(value=MED,lin=NULL)
cdf
library(testthat)
a<-9
expect_that(a, is_less_than(10))
expect_less_than(a, 10)
x <- y <- runif(100)
y[sample(100, 10)] <- 5
compare(x, y)
svymean:::
survey::svymean.
data(vardpoor::eusilc)
library(devtools)
install_github("djalmaPessoa/convey")
library(survey)
scddes<-svydesign(data=scd, prob=~1, id=~ambulance, strata=~ESA,
nest=TRUE, fpc=rep(5,6))
data(scd)
scddes<-svydesign(data=scd, prob=~1, id=~ambulance, strata=~ESA,
nest=TRUE, fpc=rep(5,6))
repweights<-2*cbind(c(1,0,1,0,1,0), c(1,0,0,1,0,1), c(0,1,1,0,0,1), c(0,1,0,1,1,0))
scdrep<-svrepdesign(data=scd, type="BRR", repweights=repweights)
weights(scdrep)
weights(scdrep, type="sampling")
weights(scdrep, type="analysis")
weights(scddes)
weights(scdrep
)
dstrat<-svydesign(id=~1,strata=~stype, weights=~pw,
data=apistrat, fpc=~fpc)
jkstrat<-as.svrepdesign(dstrat)
data(api)
dstrat<-svydesign(id=~1,strata=~stype, weights=~pw,
data=apistrat, fpc=~fpc)
jkstrat<-as.svrepdesign(dstrat)
svymean(~api00, jkstrat)
library(vardpoor)
data(eusilc)
dati=data.frame(1:nrow(eusilc),eusilc)
colnames(dati)[1] <- "IDd"
library(survey)
des_eusilc <- svydesign(ids=~db040, weights=~rb050, data=eusilc)
percent<-.6
order<-.5
htot<- h_fun(eusilc$eqIncome,eusilc$rb050)
h_fun<-function(inc_var, w){
N<-sum(w)
sd_inc <- sqrt((sum(w*inc_var*inc_var)-sum(w*inc_var)*sum(w*inc_var)/N)/N)
h <-sd_inc/exp(0.2*log(sum(w)))
h
}
htot<- h_fun(eusilc$eqIncome,eusilc$rb050)
svyquantile(~eqIncome, design=des_eusilc, .5)
computeQuantiles<-function(xx,p=quantiles){
if (any(is.na(x))) return(NA*p)
oo<-order(xx)
cum.w<-cumsum(w[oo])/sum(w)
cdf<-approxfun(cum.w,xx[oo],method=method,f=f,
yleft=min(xx),yright=max(xx),ties=min)
cdf(p)
}
computeQuantiles<-function(xx, w, p=quantiles){
if (any(is.na(x))) return(NA*p)
oo<-order(xx)
cum.w<-cumsum(w[oo])/sum(w)
cdf<-approxfun(cum.w,xx[oo],method=method,f=f,
yleft=min(xx),yright=max(xx),ties=min)
cdf(p)
}
computeQuantiles(eusilc$eqIncome,eusilc$rb050, p=.5)
computeQuantiles<-function(xx, w, p=quantiles){
#if (any(is.na(x))) return(NA*p)
oo<-order(xx)
cum.w<-cumsum(w[oo])/sum(w)
cdf<-approxfun(cum.w,xx[oo],method=method,f=f,
yleft=min(xx),yright=max(xx),ties=min)
cdf(p)
}
computeQuantiles(eusilc$eqIncome,eusilc$rb050, p=.5)
?aproxfun
?approxfun
computeQuantiles<-function(xx, w, method, p=quantiles){
#if (any(is.na(x))) return(NA*p)
oo<-order(xx)
cum.w<-cumsum(w[oo])/sum(w)
cdf<-approxfun(cum.w,xx[oo],method=method, f=f,
yleft=min(xx),yright=max(xx),ties=min)
cdf(p)
}
computeQuantiles(eusilc$eqIncome,eusilc$rb050, method = "constant", p=.5)
computeQuantiles<-function(xx, w, method, p=quantiles){
#if (any(is.na(x))) return(NA*p)
oo<-order(xx)
cum.w<-cumsum(w[oo])/sum(w)
cdf<-approxfun(cum.w,xx[oo],method=method, f=1,
yleft=min(xx),yright=max(xx),ties=min)
cdf(p)
}
computeQuantiles(eusilc$eqIncome,eusilc$rb050, method = "constant", p=.5)
computeQuantilesRounded<-function(xx, w,p=quantiles){
if (any(is.na(xx))) return(NA*p)
ww<-rowsum(w,xx,reorder=TRUE)
xx<-sort(unique(xx))
cum.w <- cumsum(ww)/sum(ww)
cdf <- approxfun(cum.w, xx, method = "constant", f = 1,
yleft = min(xx), yright = max(xx),ties=min)
cdf(p)
}
computeQuantilesRounded(eusilc$eqIncome,eusilc$rb050, method = "constant", p=.5)
computeQuantilesRounded(eusilc$eqIncome,eusilc$rb050, p=.5)
svyquantile(~eqIncome, design=des_eusilc, .5, method="constant")
computeQuantiles<-function(xx, w, p=quantiles){
#if (any(is.na(x))) return(NA*p)
oo<-order(xx)
cum.w<-cumsum(w[oo])/sum(w)
cdf<-approxfun(cum.w,xx[oo],method="constant", f=1,
yleft=min(xx),yright=max(xx),ties=min)
cdf(p)
}
computeQuantiles(eusilc$eqIncome,eusilc$rb050, method = "constant", p=.5)
computeQuantiles(eusilc$eqIncome,eusilc$rb050,  p=.5)
des_eusilc_rep <- as.svrepdesign(des_eusilc, type = "bootstrap")
svyarpt.svyrep.design <- function(formula, design, order = .50, percent =.6,...) {
inc <- terms.formula(formula)[[2]]
df <- model.frame(design)
incvar<-df[[as.character(inc)]]
w <- weights(design, "sampling")
quant_val <- computeQuantiles(incvar, w,  p = order)
quant_val <- as.vector(quant_val)
rval <- percent* quant_val
ww<-weights(design,"analysis")
qq <- apply(ww, 2, function(wi) 0.6*computeQuantiles(incvar, wi,p = order))
variance <- svrVar(qq,design$scale,design$rscales, mse=design$mse, coef=rval)
list(value= rval, se=sqrt(variance))
}
svyarpt <-  function( formula , design , ... ){
UseMethod( "svyarpt" , design )
}
svyarpt.survey.design <- function(formula, design, order = .50, percent =.6, h, ncom, comp,...) {
w <- weights(design)
ind<-names(w)
quant_val<- svyquantile(x = formula, design=design,
quantiles = order, method="constant")
quant_val <- as.vector(quant_val)
ARPT <- percent* quant_val
lin_ARPT <- percent * iqalpha(formula = formula, design = design,
alpha = order,h=h, ncom=ncom, comp=FALSE,incvec = NULL)$lin
names(lin_ARPT)<-ind
lin_ARPT_comp<-complete(lin_ARPT, ncom)
if(comp)lin<-lin_ARPT_comp else lin<-lin_ARPT
list(value = ARPT, lin = lin)
}
svyarpt.svyrep.design <- function(formula, design, order = .50, percent =.6,...) {
inc <- terms.formula(formula)[[2]]
df <- model.frame(design)
incvar<-df[[as.character(inc)]]
w <- weights(design, "sampling")
quant_val <- computeQuantiles(incvar, w,  p = order)
quant_val <- as.vector(quant_val)
rval <- percent* quant_val
ww<-weights(design,"analysis")
qq <- apply(ww, 2, function(wi) 0.6*computeQuantiles(incvar, wi,p = order))
variance <- svrVar(qq,design$scale,design$rscales, mse=design$mse, coef=rval)
list(value= rval, se=sqrt(variance))
}
lixo <- svyarpt(~eqIncome, des_eusilc_rep, order = .50, percent =.6)
lixo
install_github("DjalmaPessoa/convey")
search()
